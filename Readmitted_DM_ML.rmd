---
title: "Finals"
author: "Amenze"
date: "April 29, 2018"
output: html_document
---
The Health Facts data used was an extract representing 10 years (1999-2008) of clinical care at 130 hospitals and integrated delivery networks throughout the United States ,data Set is available from the UCI Machine Learning Repository.
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("/Users/Amenze/Desktop/614")
#install.packages("dplyr")
library(caret)
library(naniar)
library(ggplot2)
library(AppliedPredictiveModeling)
library(parallel)
library(doParallel)
library(cluster)  
library(factoextra) # clustering visualization
library(dendextend) # for comparing two dendrograms
library(pROC)
library(car)
library(ggplot2)
library(stringr)
library (ROCR)
#install.packages("rebus")
library(rebus)
#install.packages("sm")
library(sm)
set.seed(1234)
```


```{r}
########SET THE CORE#######
#get the number of cores available
numCores <- detectCores() 
#registerDoMc(cores = numCores)
# convention to leave 1 core for OS
cluster <- makeCluster(detectCores() - 1)
registerDoParallel(cluster)
stopCluster(cluster)
registerDoSEQ()

```

Initial data set had  101766 records, I used the caret function to split the data and retained 70% of the original data set for the purpose of this project. 70% of the original data set constitute 71235 records. 
71235 records was again splitted into train and test for this project 
Filename used for project;  Traindata1.csv and Testdata1.csv.

```{r, echo=FALSE}
data<-read.csv("diabetic_data.csv",na.strings=c("?","NA"))
summary(data)
######remove unknown/invalid gender####
toBeRemoved1 <- which(data$gender=="Unknown/Invalid")  
data<- data[-toBeRemoved1,]
data$gender <- factor(data$gender) 
```

```{r}
#using readmitted because its our outcome label
trainIndex <- createDataPartition(data$readmitted, p = .7, 
                                  list = FALSE, 
                                   times = 1)
dataTrain <- data[trainIndex,]
write.csv(dataTrain,"Traindata.csv")
dataTest  <- data[-trainIndex,]
write.csv(dataTest,"Testdata.csv")

```



```{r}
#using readmitted because its our outcome label
data<-read.csv("Traindata.csv")
trainIndex <- createDataPartition(data$readmitted, p = .7, 
                                  list = FALSE, 
                                   times = 1)
dataTrain <- data[trainIndex,]
write.csv(dataTrain,"Traindata1.csv")
dataTest  <- data[-trainIndex,]
write.csv(dataTest,"Testdata1.csv")

```




```{r}
data<-read.csv("Traindata1.csv")
data<-subset(data,select=-X)

data<-subset(data,select =-X.1)
summary(data)
```

For the summary of the data ,some categorical features have few record for their levels and when the data is replitted to train and test, it might get distribute to only one set. I will remove such feature 

```{r}
#categorical features with only one level are removed from the dataset 
drop<-c("acetohexamide","examide","citoglipton","metformin.pioglitazone","troglitazone","glimepiride.pioglitazone","metformin.rosiglitazone")
data<- data[,!(names(data) %in% drop)]
```


Relabel outcome features
```{r}

data$admission_type_id<-as.factor(data$admission_type_id)
data$discharge_disposition_id<-as.factor(data$discharge_disposition_id)
data$admission_source_id<-as.factor(data$admission_source_id)
#classify the outcome variable"readmitted"
data$readmitted<-as.character(data$readmitted) 
data$readmitted[data$readmitted==">30"]<-"YES" 
data$readmitted[data$readmitted=="<30"]<-"YES" 
data$readmitted[data$readmitted=="NO"]<-"NO" 
data$readmitted<-as.factor(data$readmitted)
```

Recategories  varaibles 

5 variables where categories to reduce the levels , using reference journal publication journalpublication retrieved from https://www.hindawi.com/journals/bmri/2014/781670/tab2/ And also Domain experts on the team provided guidance in which levels groups better with each other. 
1. medical_speciality.

```{r}
ggplot(data=data,aes(x =data[,"medical_specialty"],fill=readmitted))+ geom_bar()+xlab("Medical Specialty")+theme(axis.text.x = element_text(angle=45,hjust = 1))
data$medical_specialty <- as.character(data$medical_specialty)

#summary(data$medical_specialty)

data$medical_specialty[data$medical_specialty=="AllergyandImmunology"]<-"Medicine"
data$medical_specialty[data$medical_specialty =="Cardiology"] <- "Medicine"
data$medical_specialty[data$medical_specialty =="Dermatology"] <- "Medicine"
data$medical_specialty[data$medical_specialty =="Endocrinology"] <- "Medicine"
data$medical_specialty[data$medical_specialty =="Endocrinology-Metabolism"] <- "Medicine"
data$medical_specialty[data$medical_specialty =="Gastroenterology"] <- "Medicine"
data$medical_specialty[data$medical_specialty =="Hematology"] <- "Medicine"
data$medical_specialty[data$medical_specialty =="Hematology/Oncology"] <- "Medicine"
data$medical_specialty[data$medical_specialty =="InfectiousDiseases"] <- "Medicine"
data$medical_specialty[data$medical_specialty =="InternalMedicine"] <- "Medicine"
data$medical_specialty[data$medical_specialty =="Nephrology"] <- "Medicine"
data$medical_specialty[data$medical_specialty =="Neurology"] <- "Medicine"
data$medical_specialty[data$medical_specialty =="Oncology"] <- "Medicine"
data$medical_specialty[data$medical_specialty =="Pulmonology"] <- "Medicine"
data$medical_specialty[data$medical_specialty =="Rheumatology"] <- "Medicine"
data$medical_specialty[data$medical_specialty =="Orthopedics"] <- "Surgery"
data$medical_specialty[data$medical_specialty =="Orthopedics-Reconstructive"] <- "Surgery"
data$medical_specialty[data$medical_specialty =="Surgeon"] <- "Surgery"
data$medical_specialty[data$medical_specialty =="Surgery-Cardiovascular"] <- "Surgery"
data$medical_specialty[data$medical_specialty =="Surgery-Cardiovascular/Thoracic"] <- "Surgery"
data$medical_specialty[data$medical_specialty =="Surgery-Colon&Rectal"] <- "Surgery"
data$medical_specialty[data$medical_specialty =="Surgery-General"] <- "Surgery"
data$medical_specialty[data$medical_specialty =="Surgery-Maxillofacial"] <- "Surgery"
data$medical_specialty[data$medical_specialty =="Surgery-Neuro"] <- "Surgery"
data$medical_specialty[data$medical_specialty =="Surgery-Pediatric"] <- "Surgery"
data$medical_specialty[data$medical_specialty =="Surgery-Plastic"] <- "Surgery"
data$medical_specialty[data$medical_specialty =="Surgery-PlasticwithinHeadandNeck"] <- "Surgery"
data$medical_specialty[data$medical_specialty =="Surgery-Thoracic"] <- "Surgery"
data$medical_specialty[data$medical_specialty =="Surgery-Vascular"] <- "Surgery"
data$medical_specialty[data$medical_specialty =="SurgicalSpecialty"] <- "Surgery"
data$medical_specialty[data$medical_specialty =="Urology"] <- "Surgery"

data$medical_specialty[data$medical_specialty == "Anesthesiology-Pediatric"] <- "Pediatrics"
data$medical_specialty[data$medical_specialty == "Cardiology-Pediatric"] <- "Pediatrics"
data$medical_specialty[data$medical_specialty == "Pediatrics-AllergyandImmunology"] <- "Pediatrics"
data$medical_specialty[data$medical_specialty == "Pediatrics-CriticalCare"] <- "Pediatrics"
data$medical_specialty[data$medical_specialty == "Pediatrics-EmergencyMedicine"] <- "Pediatrics"
data$medical_specialty[data$medical_specialty == "Pediatrics-Endocrinology"] <- "Pediatrics"
data$medical_specialty[data$medical_specialty == "Pediatrics-Hematology-Oncology "] <- "Pediatrics"
data$medical_specialty[data$medical_specialty == "Pediatrics-InfectiousDiseases"] <- "Pediatrics"
data$medical_specialty[data$medical_specialty == "Pediatrics-Neurology"] <- "Pediatrics"
data$medical_specialty[data$medical_specialty == "Pediatrics-Pulmonology"] <- "Pediatrics"
data$medical_specialty[data$medical_specialty == "Pediatrics-Hematology-Oncology"] <- "Pediatrics"

data$medical_specialty[data$medical_specialty == "Gynecology"] <- "OB-GYN"
data$medical_specialty[data$medical_specialty == "Obsterics&Gynecology-GynecologicOnco"] <- "OB-GYN"
data$medical_specialty[data$medical_specialty == "Obstetrics"] <- "OB-GYN"              
data$medical_specialty[data$medical_specialty == "ObstetricsandGynecology"] <- "OB-GYN"
data$medical_specialty[data$medical_specialty == "Anesthesiology"] <- "Other"
data$medical_specialty[data$medical_specialty == "Dentistry"] <- "Other"
data$medical_specialty[data$medical_specialty == "DCPTEAM"] <- "Other"
data$medical_specialty[data$medical_specialty == "Hospitalist"] <- "Other"
data$medical_specialty[data$medical_specialty == "Neurophysiology"] <- "Other"
data$medical_specialty[data$medical_specialty == "Ophthalmology"] <- "Other"
data$medical_specialty[data$medical_specialty == "Osteopath"] <- "Other"
data$medical_specialty[data$medical_specialty == "Otolaryngology"] <- "Other"
data$medical_specialty[data$medical_specialty == "OutreachServices"] <- "Other"
data$medical_specialty[data$medical_specialty == "Pathology"] <- "Other"
data$medical_specialty[data$medical_specialty == "Perinatology"] <- "Other"
data$medical_specialty[data$medical_specialty == "PhysicalMedicineandRehabilitation"] <- "Other"
data$medical_specialty[data$medical_specialty == "PhysicianNotFound"] <- "Other"
data$medical_specialty[data$medical_specialty == "Podiatry"] <- "Other"
data$medical_specialty[data$medical_specialty == "Proctology"] <- "Other"                      
data$medical_specialty[data$medical_specialty == "Psychiatry"] <- "Other"                              
data$medical_specialty[data$medical_specialty == "Psychiatry-Addictive"] <- "Other" 
data$medical_specialty[data$medical_specialty == "Psychiatry-Child/Adolescent"] <- "Other" 
data$medical_specialty[data$medical_specialty == "Psychology"] <- "Other"  
data$medical_specialty[data$medical_specialty == "Radiologist"] <- "Other"  
data$medical_specialty[data$medical_specialty == "Radiology"] <- "Other"  
data$medical_specialty[data$medical_specialty == "Resident"] <- "Other"  
data$medical_specialty[data$medical_specialty == "Speech"] <- "Other"  
data$medical_specialty[data$medical_specialty == "SportsMedicine"] <- "Other"  


data$medical_specialty[is.na(data$medical_specialty)] <- "Missing/Unknown"  
  
data$medical_specialty <- as.factor(data$medical_specialty)
summary(data$medical_specialty)
```



2. diag_1 :Primary diagnosis based on ICD-9CODES
```{r}
data$diag_1 <- as.character(data$diag_1)
data$diag_1[str_detect(data$diag_1, pattern = START %R% or("39","40","41","42","43","44","45","785")) == T] <- "Circulatory"
data$diag_1[str_detect(data$diag_1, pattern = START %R% or("46","47","48","49","50","51","786")) == T] <- "Respiratory"
data$diag_1[str_detect(data$diag_1, pattern = START %R% or("52","53","54","55","56","57","787")) == T] <- "Digestive"
data$diag_1[str_detect(data$diag_1, pattern = START %R% "25") == T] <- "Diabetes"
data$diag_1[str_detect(data$diag_1, pattern = START %R% or("80","81","82","83","84","85",
                                                              "86","87","88","89","90","91",
                                                              "92","93","94","95","96","97",
                                                              "98","99")) == T] <- "Injury"
data$diag_1[str_detect(data$diag_1, pattern = START %R% or("71","72","73")) == T] <- "Musculoskeletal"
data$diag_1[str_detect(data$diag_1, pattern = START %R% or("58","59","60","61","62","788")) == T] <- "Genitourinary"



data$diag_1[str_detect(data$diag_1, pattern = START %R% or("14","15","16","17","18","19",
                                                              "20","21","22","23")) == T] <- "Neoplasms"

data$diag_1[str_detect(data$diag_1, pattern = "[[:digit:]]") == T] <- "Other"
data$diag_1 <- as.factor(data$diag_1)
summary(data$diag_1)





```


3..Admission type Id re-level based on data descriptive
```{r}
#summary(data$admission_type_id)
data$admission_type_id<-as.character(data$admission_type_id)
ER<-as.character(c(1,2))
for (i in ER){
   data$admission_type_id[data$admission_type_id == i] <- "Emergency"
}

data$admission_type_id[data$admission_type_id == "3"] <- "Elective"
data$admission_type_id[data$admission_type_id == "4"] <- "Newborn"

NT<-as.character(c(5,6,8))
for (i in NT){
   data$admission_type_id[data$admission_type_id == i] <- "Not Available"}

data$admission_type_id[data$admission_type_id == "7"] <- "Trauma Center"
  
data$admission_type_id<-as.factor(data$admission_type_id)
summary(data$admission_type_id)
```


4.Admisiion Source id
```{r}
#summary(data$admission_source_id)
ggplot(data=data, aes(x =data$admission_source_id,fill=readmitted),stat="identity")+ geom_bar()+xlab("admission_source_id")

data$admission_source_id <- as.character(data$admission_source_id)

Refer<-as.character(c(1,2,3)) #Physician Referral,Clinic Referral,HMO Referral

for (i in Refer){ 
 data$admission_source_id[data$admission_source_id==i]<-'Referral'}


Tsfr<-as.character(c(4,5,6,10,18,19,22,25,26)) #(Transfer from a hospital, Transfer from a Skilled Nursing Facility (SNF),Transfer from another health care facility,Transfer from critial access hospital, Transfer From Another Home Health Agency,Readmission to Same Home Health Agency, Transfer from hospital inpt/same fac reslt in a sep claim, Transfer from Ambulatory Surgery Center,Transfer from Hospice)

for (i in Tsfr){
  data$admission_source_id[data$admission_source_id==i]<- 'Transfer'
}

data$admission_source_id[data$admission_source_id== "7"] <- "ER"  # Emergency Room
data$admission_source_id[data$admission_source_id== "8"] <- "Court" #Court/Law Enforcement

Nt_av<-as.character(c(9,15,17,20,21)) # Not Available,Not Available,NULL,Not Mapped,Unknown/Invalid
for (i in Nt_av){
  data$admission_source_id[data$admission_source_id==i]<- 'Unknown'}

pedia<-as.character(c(11,12,13,14,23,24)) #(Normal Delivery, Premature Delivery,Sick Baby,Extramural Birth, Born inside this hospital, Born outside this hospital)
for (i in pedia){
   data$admission_source_id[data$admission_source_id==i] <-"Pediatric"
}
data$admission_source_id <- as.factor(data$admission_source_id)
summary(data$admission_source_id)
```




5. Discharge_disposition_id
```{r}
data$discharge_disposition_id <- as.character(data$discharge_disposition_id)
data$discharge_disposition_id[data$discharge_disposition_id==1] <- 'Home'
IN<-as.character(c(2,5,28))
for (i in IN){
   data$discharge_disposition_id[data$discharge_disposition_id==i]<-'Inpatient' 
}

OUT<-as.character(c(3,4,16,17,22,23,24))
for (i in OUT){
    data$discharge_disposition_id[data$discharge_disposition_id==i]<-'Outpatient'}

Hh<-as.character(c(6,8))
for (i in Hh){
  data$discharge_disposition_id[data$discharge_disposition_id==i]<-'Home Health'}

data$discharge_disposition_id[data$discharge_disposition_id=='7']<-'AMA'

EX<-as.character(c(11,19,20,21))
for (i in EX){
    data$discharge_disposition_id[data$discharge_disposition_id==i]<-'Expired'}

Sint<-as.character(c(12,15))
for (i in Sint){
   data$discharge_disposition_id[data$discharge_disposition_id==i]<-'Same Institute'}

Hos<-as.character(c(13,14))
for (i in Hos){
    data$discharge_disposition_id[data$discharge_disposition_id==i]<-'Hospice'}
Nas<-as.character(c(27,29,30))
for (i in Nas){
    data$discharge_disposition_id[data$discharge_disposition_id==i]<-'NA'}
Unk<-as.character(c(9,10,18,25,26))
for ( i in Unk ){
  data$discharge_disposition_id[data$discharge_disposition_id==i] <-'Unknown'}

INP<-as.character(c(2,5,28))
for (i in INP){
   data$discharge_disposition_id[data$discharge_disposition_id==i]<-'Inpatient' }

data$discharge_disposition_id <- as.factor(data$discharge_disposition_id)
summary(data$discharge_disposition_id)

```


```{r}
#Recategories Age feature
summary(data$age)
ggplot(data=data, aes(x =data$age,fill=readmitted),stat="identity")+ geom_bar()+xlab("Age")
data$age<-as.character(data$age)
#data<-data2
data$age[data$age=="[0-10)"]<- "[0-30)" 
data$age[data$age=="[10-20)"]<- "[0-30)" 
data$age[data$age=="[20-30)"]<-"[0-30)" 
data$age[data$age=="[30-40)"]<-"[30-60)"
data$age[data$age=="[40-50)"]<-"[30-60)"
data$age[data$age=="[50-60)"]<-"[30-60)"
data$age[data$age=="[60-70)"]<-"[60-100)"
data$age[data$age=="[70-80)"]<-"[60-100)"
data$age[data$age=="[80-90)"]<-"[60-100)"
data$age[data$age=="[80-90)"]<-"[60-100)"
data$age[data$age=="[90-100)"]<-"[60-100)"
data$age<-as.factor(data$age)
table(data$age)

```








More Exploration
checking Amount of missing result
The amount of missing observations in weight is 48345, We will need to remove this features, because if we remove only the NA's we weill lose alot of data.
payer_code has 19701  missing values

```{r}
#####checking for missing values###
dim(data)
any(is.na(data))
sum(is.na(data))/prod(dim(data))
gg_miss_var(data)
colSums(is.na(data))
```



Admission_type_id ,discharge_disposition_id and admission_source_id are categories to  as factor varable based on the data description from UCI Machine learning REPO.

I also recategories the outcome variables into  YES( readmission) and NO(no readmission)

Plotted the categorical variable using barchart 

```{r}
namelist<-c("race","gender","age","admission_type_id","admission_source_id","A1Cresult","insulin","change","diabetesMed")
for (name in namelist){
  plots<-ggplot(data=data, aes(x =data[,name],fill=readmitted),stat="identity")+ geom_bar()+xlab(name)
  print(plots)
}

ggplot(data=data,aes(x =data[,"medical_specialty"],fill=readmitted))+ geom_bar()+xlab("medical specialty")+theme(axis.text.x = element_text(angle=45,hjust = 1))

```

Race: The data set have more caucasian than the other races.
Gender: There are more Females compared to male Also looking at the split there is almost a balance between readmission or No readmission for both race.
AGE:majority of the record in the dataset are between 60-100 years.  the distribution for the age is skewed to the left. 
Admission_type_id: We have more patients in the Emergency dept. 
Admission source: most of the record in the dataset have admission source  ER (unimodal) 
A1Cresult: patients whose A1Cresult was measured are more in the dataset when compared with patients with A1Cresult>7,A1Cresult>8 or A1Cresult= Norm.(unimodal)
Insulin: Patient with No insulin are more, 
diabetesMed: Patient who had diabetesMed have almost same occurance of being readmitted or not . 
change:change in diabetic medications between readmitted or NO redmission are somewhat similar 


```{r}
# Filled Density Plot
d <- density(data$num_lab_procedures)
plot(d, main="Kernel Density of num_lab_procedures",col="red")


# plot densities

sm.density.compare(data$num_medications, data$readmitted, xlab="Num of medications")
title(main="MPG Distribution by Car Cylinders")
```


Density plot for num_lab_procedure: the data is shewed to the left, we can infer that the large number of patient have lab procedures between 40 and 60. it also begins to declain as the number of procedures increases

Density plot for Num_of Medication: the large amout of the pateint take 0 to 20 medications and there is no much difference between readmitted or had no outcome 


```{r}
ggplot(data, aes(x=readmitted, y=time_in_hospital,fill=readmitted))+geom_boxplot(outlier.colour="red", outlier.shape=8,
                outlier.size=4)


#scattered plot
namelist<-c("time_in_hospital","num_lab_procedures","num_procedures", "num_medications","number_outpatient","number_emergency","number_inpatient","number_diagnoses")
data_num<-data[,names(data) %in% namelist]
cor(data_num)
```

Box Plot:  As expected the mean value for time in hospital is longer for patients who were readmitted when compared with no readmission than , we can also see some  outliers colored in Red.
           
    
     
Scattered Plot no strong correlation between the variables. I look at the effect size for time in hosipital & number of labprocedures(0.3175420161)
                                                                                          Time in hospital & number of Medications(0.46453044) 




Delete features
Weight is removed because it has too many missing values.from the thre diagnoses we pick only the primary diagnosis and dropped the otheres. Also the encounter and payer code ids are drops

I will be fixing the model with 39 variables . each of these variables retained based on pervious visualization, regrouping and the essence of the feature from a clinical prospect. 
```{r}
drop<-c("weight","diag_2","diag_3","encounter_id","patient_nbr","payer_code")
data<-data[,!names(data) %in% drop]
dim(data)
any(is.na(data))
sum(is.na(data))/prod(dim(data))
gg_miss_var(data)
colSums(is.na(data))
#table(data$discharge_disposition_id)
row.has.na <- apply(data, 1, function(x){any(is.na(x))})
sum(row.has.na)
data<- data[!row.has.na,]
any(is.na(data))

```


Normalization:
the numeric variable for the dataset have different ranges
when some features have different ranges in their values it will affect negatively the algorithms because the feature with bigger values will take more influence.


```{r}
# Normalization 
#summary(data)
namelist<-c("time_in_hospital","num_lab_procedures","num_procedures","num_medications","number_outpatient","number_emergency","number_inpatient","number_diagnoses")
preProcValues <- preProcess(data, method = c("center","scale"))
data <- predict(preProcValues, data)
```


kmeans clustering
center: Subtract Mean
scale: Divide by standard deviation
nstart = 20. This means that R will try 20 different random starting assignments and then select the one with the lowest within cluster variation.
k=2 for the number of clusters I want 
```{r}

# K-Means Cluster Analysis
# library (cluster)
# install.packages("vegan")
# library (vegan)

data_num<-data[,names(data) %in% namelist]
fit <- kmeans(data_num, 2,nstart=20) # 2 cluster solution
fit

#We can also plot the data to see the clusters:

fviz_cluster(fit, data =data_num)

# Silhouette method
fviz_nbclust(data_num[sample(nrow(data_num), 1000),], kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")


# Elbow method
fviz_nbclust(data_num[sample(nrow(data_num), 1000),], kmeans, method = "wss") +
    geom_vline(xintercept = 4, linetype = 2)+
  labs(subtitle = "Elbow method")

fviz_nbclust(data_num[sample(nrow(data_num), 1000),], kmeans, nstart = 20,  method = "gap_stat", nboot = 50)+
  labs(subtitle = "Gap statistic method")



# # get cluster means 
# aggregate(data_num,by=list(fit$cluster),FUN=mean)
# 
# #We can also plot the data to see the clusters:
# 
# # clusplot(data_num, fit$cluster, color=TRUE, shade=TRUE, 
# #          labels=2, lines=0,main="Figure 1")
# 
# fit$cluster <- as.factor(fit$cluster)
# ggplot(data_num, aes(num_lab_procedures, num_medications, color = fit$cluster)) + geom_point()



```
K-means clustering with 2 clusters of sizes 31317, 17375  representing the datapoints in the respective clusters.

Cluster means:cluster means for each feature are the constants that minimize the sum-of-squared deviations

total within-cluster sum of squares,which we seek to minimize by performing K-means clustering, The 16.0 % is a measure of the total variance in the data set that is explained by the clustering. k-means minimize the within group dispersion and maximize the between-group dispersion.

 Taking a look at the cluster plot , the algorithm clusters the dataset into 2clusters represented in the ciricles red and blue, however we  can observe an overlap with these two clusters. 
 


Scoring Metric: Note 
The disadvantage of elbow and average silhouette methods is that, they measure a global clustering characteristic only. A more sophisticated method is to use the gap statistic which provides a statistical procedure to formalize the elbow/silhouette heuristic in order to estimate the optimal number of clusters. 


Hierarchical Clustering

```{r}
# Dissimilarity matrix
#I used sample function to cluster only 20000 of the training dataset
d <- dist(data_num[sample(nrow(data_num), 1000), ], method = "euclidean")

# Hierarchical clustering using Ward.D2 Linkage
hc1 <- hclust(d, method = "ward.D2" )

# Plot the obtained dendrogram
plot(hc1, 
     main = "Clustered readmission data set", cex = .06)

fviz_nbclust(data_num[sample(nrow(data_num), 1000),], FUN=hcut,method = "silhouette")

```

The dist() function is used dist() to compute the matrix inter-observation Euclidean distance matrix

Hierarchical Clustering split the dataset into two main clusters from the top. Thes two big branches sub divide into sub trees



TEST DATA PROCESSING
```{r}



Testdata<-read.csv("Testdata1.csv")
Testdata<-subset(Testdata,select=-X)
Testdata<-subset(Testdata,select=-X.1)
summary(Testdata)
#categorical features with only one level are removed from the Testdataset 
drop<-c("acetohexamide","examide","citoglipton","metformin.pioglitazone","troglitazone","glimepiride.pioglitazone","metformin.rosiglitazone")
Testdata<- Testdata[,!(names(Testdata) %in% drop)]

toBeRemoved1 <- which(Testdata$chlorpropamide=="Down")  
Testdata<- Testdata[-toBeRemoved1,]
Testdata$chlorpropamide <- factor(Testdata$chlorpropamide) 


Testdata$admission_type_id<-as.factor(Testdata$admission_type_id)
Testdata$discharge_disposition_id<-as.factor(Testdata$discharge_disposition_id)
Testdata$admission_source_id<-as.factor(Testdata$admission_source_id)
#classify the outcome variable"readmitted"
Testdata$readmitted<-as.character(Testdata$readmitted) 
Testdata$readmitted[Testdata$readmitted==">30"]<-"YES" 
Testdata$readmitted[Testdata$readmitted=="<30"]<-"YES" 
Testdata$readmitted[Testdata$readmitted=="NO"]<-"NO" 
Testdata$readmitted<-as.factor(Testdata$readmitted)



#ggplot(Testdata=Testdata,aes(x =Testdata[,"medical_specialty"],fill=readmitted))+ geom_bar()+xlab("Medical Specialty")+theme(axis.text.x = element_text(angle=45,hjust = 1))
Testdata$medical_specialty <- as.character(Testdata$medical_specialty)

#summary(Testdata$medical_specialty)

Testdata$medical_specialty[Testdata$medical_specialty=="AllergyandImmunology"]<-"Medicine"
Testdata$medical_specialty[Testdata$medical_specialty =="Cardiology"] <- "Medicine"
Testdata$medical_specialty[Testdata$medical_specialty =="Dermatology"] <- "Medicine"
Testdata$medical_specialty[Testdata$medical_specialty =="Endocrinology"] <- "Medicine"
Testdata$medical_specialty[Testdata$medical_specialty =="Endocrinology-Metabolism"] <- "Medicine"
Testdata$medical_specialty[Testdata$medical_specialty =="Gastroenterology"] <- "Medicine"
Testdata$medical_specialty[Testdata$medical_specialty =="Hematology"] <- "Medicine"
Testdata$medical_specialty[Testdata$medical_specialty =="Hematology/Oncology"] <- "Medicine"
Testdata$medical_specialty[Testdata$medical_specialty =="InfectiousDiseases"] <- "Medicine"
Testdata$medical_specialty[Testdata$medical_specialty =="InternalMedicine"] <- "Medicine"
Testdata$medical_specialty[Testdata$medical_specialty =="Nephrology"] <- "Medicine"
Testdata$medical_specialty[Testdata$medical_specialty =="Neurology"] <- "Medicine"
Testdata$medical_specialty[Testdata$medical_specialty =="Oncology"] <- "Medicine"
Testdata$medical_specialty[Testdata$medical_specialty =="Pulmonology"] <- "Medicine"
Testdata$medical_specialty[Testdata$medical_specialty =="Rheumatology"] <- "Medicine"
Testdata$medical_specialty[Testdata$medical_specialty =="Orthopedics"] <- "Surgery"
Testdata$medical_specialty[Testdata$medical_specialty =="Orthopedics-Reconstructive"] <- "Surgery"
Testdata$medical_specialty[Testdata$medical_specialty =="Surgeon"] <- "Surgery"
Testdata$medical_specialty[Testdata$medical_specialty =="Surgery-Cardiovascular"] <- "Surgery"
Testdata$medical_specialty[Testdata$medical_specialty =="Surgery-Cardiovascular/Thoracic"] <- "Surgery"
Testdata$medical_specialty[Testdata$medical_specialty =="Surgery-Colon&Rectal"] <- "Surgery"
Testdata$medical_specialty[Testdata$medical_specialty =="Surgery-General"] <- "Surgery"
Testdata$medical_specialty[Testdata$medical_specialty =="Surgery-Maxillofacial"] <- "Surgery"
Testdata$medical_specialty[Testdata$medical_specialty =="Surgery-Neuro"] <- "Surgery"
Testdata$medical_specialty[Testdata$medical_specialty =="Surgery-Pediatric"] <- "Surgery"
Testdata$medical_specialty[Testdata$medical_specialty =="Surgery-Plastic"] <- "Surgery"
Testdata$medical_specialty[Testdata$medical_specialty =="Surgery-PlasticwithinHeadandNeck"] <- "Surgery"
Testdata$medical_specialty[Testdata$medical_specialty =="Surgery-Thoracic"] <- "Surgery"
Testdata$medical_specialty[Testdata$medical_specialty =="Surgery-Vascular"] <- "Surgery"
Testdata$medical_specialty[Testdata$medical_specialty =="SurgicalSpecialty"] <- "Surgery"
Testdata$medical_specialty[Testdata$medical_specialty =="Urology"] <- "Surgery"

Testdata$medical_specialty[Testdata$medical_specialty == "Anesthesiology-Pediatric"] <- "Pediatrics"
Testdata$medical_specialty[Testdata$medical_specialty == "Cardiology-Pediatric"] <- "Pediatrics"
Testdata$medical_specialty[Testdata$medical_specialty == "Pediatrics-AllergyandImmunology"] <- "Pediatrics"
Testdata$medical_specialty[Testdata$medical_specialty == "Pediatrics-CriticalCare"] <- "Pediatrics"
Testdata$medical_specialty[Testdata$medical_specialty == "Pediatrics-EmergencyMedicine"] <- "Pediatrics"
Testdata$medical_specialty[Testdata$medical_specialty == "Pediatrics-Endocrinology"] <- "Pediatrics"
Testdata$medical_specialty[Testdata$medical_specialty == "Pediatrics-Hematology-Oncology "] <- "Pediatrics"
Testdata$medical_specialty[Testdata$medical_specialty == "Pediatrics-InfectiousDiseases"] <- "Pediatrics"
Testdata$medical_specialty[Testdata$medical_specialty == "Pediatrics-Neurology"] <- "Pediatrics"
Testdata$medical_specialty[Testdata$medical_specialty == "Pediatrics-Pulmonology"] <- "Pediatrics"
Testdata$medical_specialty[Testdata$medical_specialty == "Pediatrics-Hematology-Oncology"] <- "Pediatrics"

Testdata$medical_specialty[Testdata$medical_specialty == "Gynecology"] <- "OB-GYN"
Testdata$medical_specialty[Testdata$medical_specialty == "Obsterics&Gynecology-GynecologicOnco"] <- "OB-GYN"
Testdata$medical_specialty[Testdata$medical_specialty == "Obstetrics"] <- "OB-GYN"              
Testdata$medical_specialty[Testdata$medical_specialty == "ObstetricsandGynecology"] <- "OB-GYN"
Testdata$medical_specialty[Testdata$medical_specialty == "Anesthesiology"] <- "Other"
Testdata$medical_specialty[Testdata$medical_specialty == "Dentistry"] <- "Other"
Testdata$medical_specialty[Testdata$medical_specialty == "DCPTEAM"] <- "Other"
Testdata$medical_specialty[Testdata$medical_specialty == "Hospitalist"] <- "Other"
Testdata$medical_specialty[Testdata$medical_specialty == "Neurophysiology"] <- "Other"
Testdata$medical_specialty[Testdata$medical_specialty == "Ophthalmology"] <- "Other"
Testdata$medical_specialty[Testdata$medical_specialty == "Osteopath"] <- "Other"
Testdata$medical_specialty[Testdata$medical_specialty == "Otolaryngology"] <- "Other"
Testdata$medical_specialty[Testdata$medical_specialty == "OutreachServices"] <- "Other"
Testdata$medical_specialty[Testdata$medical_specialty == "Pathology"] <- "Other"
Testdata$medical_specialty[Testdata$medical_specialty == "Perinatology"] <- "Other"
Testdata$medical_specialty[Testdata$medical_specialty == "PhysicalMedicineandRehabilitation"] <- "Other"
Testdata$medical_specialty[Testdata$medical_specialty == "PhysicianNotFound"] <- "Other"
Testdata$medical_specialty[Testdata$medical_specialty == "Podiatry"] <- "Other"
Testdata$medical_specialty[Testdata$medical_specialty == "Proctology"] <- "Other"                      
Testdata$medical_specialty[Testdata$medical_specialty == "Psychiatry"] <- "Other"                              
Testdata$medical_specialty[Testdata$medical_specialty == "Psychiatry-Addictive"] <- "Other" 
Testdata$medical_specialty[Testdata$medical_specialty == "Psychiatry-Child/Adolescent"] <- "Other" 
Testdata$medical_specialty[Testdata$medical_specialty == "Psychology"] <- "Other"  
Testdata$medical_specialty[Testdata$medical_specialty == "Radiologist"] <- "Other"  
Testdata$medical_specialty[Testdata$medical_specialty == "Radiology"] <- "Other"  
Testdata$medical_specialty[Testdata$medical_specialty == "Resident"] <- "Other"  
Testdata$medical_specialty[Testdata$medical_specialty == "Speech"] <- "Other"  
Testdata$medical_specialty[Testdata$medical_specialty == "SportsMedicine"] <- "Other"  


Testdata$medical_specialty[is.na(Testdata$medical_specialty)] <- "Missing/Unknown"  
  
Testdata$medical_specialty <- as.factor(Testdata$medical_specialty)
summary(Testdata$medical_specialty)



Testdata$diag_1 <- as.character(Testdata$diag_1)
Testdata$diag_1[str_detect(Testdata$diag_1, pattern = START %R% or("39","40","41","42","43","44","45","785")) == T] <- "Circulatory"
Testdata$diag_1[str_detect(Testdata$diag_1, pattern = START %R% or("46","47","48","49","50","51","786")) == T] <- "Respiratory"
Testdata$diag_1[str_detect(Testdata$diag_1, pattern = START %R% or("52","53","54","55","56","57","787")) == T] <- "Digestive"
Testdata$diag_1[str_detect(Testdata$diag_1, pattern = START %R% "25") == T] <- "Diabetes"
Testdata$diag_1[str_detect(Testdata$diag_1, pattern = START %R% or("80","81","82","83","84","85",
                                                              "86","87","88","89","90","91",
                                                              "92","93","94","95","96","97",
                                                              "98","99")) == T] <- "Injury"
Testdata$diag_1[str_detect(Testdata$diag_1, pattern = START %R% or("71","72","73")) == T] <- "Musculoskeletal"
Testdata$diag_1[str_detect(Testdata$diag_1, pattern = START %R% or("58","59","60","61","62","788")) == T] <- "Genitourinary"



Testdata$diag_1[str_detect(Testdata$diag_1, pattern = START %R% or("14","15","16","17","18","19",
                                                              "20","21","22","23")) == T] <- "Neoplasms"

Testdata$diag_1[str_detect(Testdata$diag_1, pattern = "[[:digit:]]") == T] <- "Other"
Testdata$diag_1 <- as.factor(Testdata$diag_1)
summary(Testdata$diag_1)


#summary(Testdata$admission_type_id)
Testdata$admission_type_id<-as.character(Testdata$admission_type_id)
ER<-as.character(c(1,2))
for (i in ER){
   Testdata$admission_type_id[Testdata$admission_type_id == i] <- "Emergency"
}

Testdata$admission_type_id[Testdata$admission_type_id == "3"] <- "Elective"
Testdata$admission_type_id[Testdata$admission_type_id == "4"] <- "Newborn"

NT<-as.character(c(5,6,8))
for (i in NT){
   Testdata$admission_type_id[Testdata$admission_type_id == i] <- "Not Available"}

Testdata$admission_type_id[Testdata$admission_type_id == "7"] <- "Trauma Center"
  
Testdata$admission_type_id<-as.factor(Testdata$admission_type_id)
summary(Testdata$admission_type_id)



#summary(Testdata$admission_source_id)
#ggplot(Testdata=Testdata, aes(x =Testdata$admission_source_id,fill=readmitted),stat="identity")+ geom_bar()+xlab("admission_source_id")

Testdata$admission_source_id <- as.character(Testdata$admission_source_id)

Refer<-as.character(c(1,2,3)) #Physician Referral,Clinic Referral,HMO Referral

for (i in Refer){ 
 Testdata$admission_source_id[Testdata$admission_source_id==i]<-'Referral'}


Tsfr<-as.character(c(4,5,6,10,18,19,22,25,26)) #(Transfer from a hospital, Transfer from a Skilled Nursing Facility (SNF),Transfer from another health care facility,Transfer from critial access hospital, Transfer From Another Home Health Agency,Readmission to Same Home Health Agency, Transfer from hospital inpt/same fac reslt in a sep claim, Transfer from Ambulatory Surgery Center,Transfer from Hospice)

for (i in Tsfr){
  Testdata$admission_source_id[Testdata$admission_source_id==i]<- 'Transfer'
}

Testdata$admission_source_id[Testdata$admission_source_id== "7"] <- "ER"  # Emergency Room
Testdata$admission_source_id[Testdata$admission_source_id== "8"] <- "Court" #Court/Law Enforcement

Nt_av<-as.character(c(9,15,17,20,21)) # Not Available,Not Available,NULL,Not Mapped,Unknown/Invalid
for (i in Nt_av){
  Testdata$admission_source_id[Testdata$admission_source_id==i]<- 'Unknown'}

pedia<-as.character(c(11,12,13,14,23,24)) #(Normal Delivery, Premature Delivery,Sick Baby,Extramural Birth, Born inside this hospital, Born outside this hospital)
for (i in pedia){
   Testdata$admission_source_id[Testdata$admission_source_id==i] <-"Pediatric"
}
Testdata$admission_source_id <- as.factor(Testdata$admission_source_id)
summary(Testdata$admission_source_id)



Testdata$discharge_disposition_id <- as.character(Testdata$discharge_disposition_id)
Testdata$discharge_disposition_id[Testdata$discharge_disposition_id==1] <- 'Home'
IN<-as.character(c(2,5,28))
for (i in IN){
   Testdata$discharge_disposition_id[Testdata$discharge_disposition_id==i]<-'Inpatient' 
}

OUT<-as.character(c(3,4,16,17,22,23,24))
for (i in OUT){
    Testdata$discharge_disposition_id[Testdata$discharge_disposition_id==i]<-'Outpatient'}

Hh<-as.character(c(6,8))
for (i in Hh){
  Testdata$discharge_disposition_id[Testdata$discharge_disposition_id==i]<-'Home Health'}

Testdata$discharge_disposition_id[Testdata$discharge_disposition_id=='7']<-'AMA'

EX<-as.character(c(11,19,20,21))
for (i in EX){
    Testdata$discharge_disposition_id[Testdata$discharge_disposition_id==i]<-'Expired'}

Sint<-as.character(c(12,15))
for (i in Sint){
   Testdata$discharge_disposition_id[Testdata$discharge_disposition_id==i]<-'Same Institute'}

Hos<-as.character(c(13,14))
for (i in Hos){
    Testdata$discharge_disposition_id[Testdata$discharge_disposition_id==i]<-'Hospice'}
Nas<-as.character(c(27,29,30))
for (i in Nas){
    Testdata$discharge_disposition_id[Testdata$discharge_disposition_id==i]<-'NA'}
Unk<-as.character(c(9,10,18,25,26))
for ( i in Unk ){
  Testdata$discharge_disposition_id[Testdata$discharge_disposition_id==i] <-'Unknown'}

INP<-as.character(c(2,5,28))
for (i in INP){
   Testdata$discharge_disposition_id[Testdata$discharge_disposition_id==i]<-'Inpatient' }

Testdata$discharge_disposition_id <- as.factor(Testdata$discharge_disposition_id)
summary(Testdata$discharge_disposition_id)



#summary(Testdata$age)
#ggplot(Testdata=Testdata, aes(x =Testdata$age,fill=readmitted),stat="identity")+ geom_bar()+xlab("Age")
Testdata$age<-as.character(Testdata$age)
#Testdata<-Testdata2
Testdata$age[Testdata$age=="[0-10)"]<- "[0-30)" 
Testdata$age[Testdata$age=="[10-20)"]<- "[0-30)" 
Testdata$age[Testdata$age=="[20-30)"]<-"[0-30)" 
Testdata$age[Testdata$age=="[30-40)"]<-"[30-60)"
Testdata$age[Testdata$age=="[40-50)"]<-"[30-60)"
Testdata$age[Testdata$age=="[50-60)"]<-"[30-60)"
Testdata$age[Testdata$age=="[60-70)"]<-"[60-100)"
Testdata$age[Testdata$age=="[70-80)"]<-"[60-100)"
Testdata$age[Testdata$age=="[80-90)"]<-"[60-100)"
Testdata$age[Testdata$age=="[80-90)"]<-"[60-100)"
Testdata$age[Testdata$age=="[90-100)"]<-"[60-100)"
Testdata$age<-as.factor(Testdata$age)
table(Testdata$age)

dim(Testdata)
any(is.na(Testdata))
sum(is.na(Testdata))/prod(dim(Testdata))
gg_miss_var(Testdata)
colSums(is.na(Testdata))

drop<-c("weight","diag_2","diag_3","encounter_id","patient_nbr","payer_code")
Testdata<-Testdata[,!names(Testdata) %in% drop]
dim(Testdata)
any(is.na(Testdata))
sum(is.na(Testdata))/prod(dim(Testdata))
gg_miss_var(Testdata)
colSums(is.na(Testdata))
#table(Testdata$discharge_disposition_id)
row.has.na <- apply(Testdata, 1, function(x){any(is.na(x))})
sum(row.has.na)
Testdata<- Testdata[!row.has.na,]
any(is.na(Testdata))



Testdata <- predict(preProcValues, Testdata)
```





Classification Feature Data exploration.
```{r}
data_fact<-data[,!names(data) %in% namelist]
for (name in names(data_fact)){
  plots<-ggplot(data=data, aes(x =data[,name],fill=readmitted)) + geom_bar()+theme(axis.text.x = element_text(angle=45,hjust = 1))+labs(x=name)
  #print(name)
  print(plots)
}

```


```{r}
data_num<-data[,names(data) %in% namelist]

for (i in 1:(ncol(data_num)-1))
  local({
    i <- i
    g1 <- ggplot(data=data_num)
    p1 <- g1 + geom_point(aes(data_num[,i],data_num[,i+1],color=data$readmitted)) +
      xlab(colnames(data_num[i])) +
      ylab(colnames(data_num[i+1])) +
      ggtitle("scattered plot") 
    plot(p1)})

```

Random Forest #https://www.hackingnote.com/en/machine-learning/algorithms-pros-and-cons/
RF is good for parallel or distributed computing.
Almost always have lower classification error and better f-scores than decision trees.
Almost always perform as well as or better than SVMs, but are far easier for humans to understand.
Deal really well with uneven data sets that have missing variables.
Give you a really good idea of which features in your data set are the most important.
Generally train faster than SVMs (though this obviously depends on your implementation).



R's random forest implementation can only handle 32 factor levels - if you have more than that then you either need to split your factors into smaller subsets, or create a dummy variable for each level

Random forests have been observed to overfit for some datasets with noisy classification/regression tasks

RFs nice features is their ability to calculate the importance of features for separating classes

I began my project using Logistic Regression and the SVM  , but I had to create dummy variable for the models and my dataset has  lot of categorical variable with level, the dummy variable will increase the size of mt dataset and I will also mean high computational time for my machine.  When I used the random Forest I had better accuracy .



Parameter used :
To change the candidate values of the tuning parameter, either of the tuneLength or tuneGrid arguments can be used. The train function can generate a candidate set of parameter values and the tuneLength argument controls how many are evaluated. 

To modify the resampling method, a trainControl function is used. The option method controls the type of resampling and defaults to "boot". Another method, "repeatedcv", is used to specify repeated K-fold cross-validation (and the argument repeats controls the number of repetitions). 


grid search for optimizing hyperparameters of a random forest. All parameters that influence the learning are searched simultaneously (except for the number of estimators, which poses a time / quality tradeoff).

```{r}
fitControl <-  trainControl(method = "repeatedcv", number = 5, repeats=3, 
                           savePredictions="final", classProbs=TRUE, search="grid")
tunegrid <- expand.grid(.mtry=c(1:10),
                        .splitrule = "gini",
                        .min.node.size = c(10, 20))
x<-data[,37]
model_randomForest<- train(readmitted ~ .,data,
                method = "ranger", metric= "Accuracy", tuneGrid=tunegrid,trControl = fitControl)
# print model
model_randomForest

plot(model_randomForest)

any(is.na(data))
```







PREDICTION
```{r}

predictions <- predict(object=model_randomForest,Testdata, type='raw')
predictions
```

```{r}
confusionMatrix(data = predictions, Testdata$readmitted)
# Recall-Precision curve  

precision <- posPredValue(predictions, Testdata$readmitted, positive="YES")
recall <- sensitivity(predictions, Testdata$readmitted, positive="YES")

F1 <- (2 * precision * recall) / (precision + recall)
F1

```


sensitivity = 74%(0.7281) of patients who are readmitted in the hospital as predicted by the model were actually readmitted in the hospital  

specificity = 53%(0.5277) of patient who where predicted as no readmission by the model were actually not readmitted

accuracy =64%(0.6405) The predicted model for readmission or no readmission was 64.05% accurate, 

F1 =  0.5765959 is a measure of a test's accuracy. It considers both the precision p and the recall r of the test to compute the score



```{r}


plot(roc(Testdata$readmitted, predictions[,2]), print.auc = TRUE, col = "red", asp = NA, legacy.axes = TRUE)

```
            
            
AUC = 0.695
the AUC quantifies the overall ability of the model to discriminate between patients who where readmitted and those who weren't  
            
            
            